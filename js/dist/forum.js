(()=>{var t={n:r=>{var a=r&&r.__esModule?()=>r.default:()=>r;return t.d(a,{a}),a},d:(r,a)=>{for(var o in a)t.o(a,o)&&!t.o(r,o)&&Object.defineProperty(r,o,{enumerable:!0,get:a[o]})},o:(t,r)=>Object.prototype.hasOwnProperty.call(t,r),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},r={};(()=>{"use strict";t.r(r);const a=flarum.core.compat["common/app"];t.n(a)().initializers.add("xypp/pay-to-read",(function(){}));const o=flarum.core.compat["forum/app"];var e=t.n(o);const n=flarum.core.compat["forum/components/CommentPost"];var p=t.n(n);const s=flarum.core.compat["common/extend"],i=flarum.core.compat["common/components/TextEditor"];var d=t.n(i);const c=flarum.core.compat["common/components/TextEditorButton"];var l=t.n(c);const u=flarum.core.compat["forum/components/LogInModal"];var y=t.n(u);const f=flarum.core.compat["forum/components/DiscussionPage"];var h=t.n(f);function b(t,r){return b=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},b(t,r)}const x=flarum.core.compat["common/components/Modal"];var v=t.n(x);const g=flarum.core.compat["components/Button"];var T=t.n(g);const _=flarum.core.compat["common/utils/setRouteWithForcedRefresh"];var C=t.n(_);flarum.core.compat["common/components/Alert/Alert"];var k=function(t){var r,a;function o(){for(var r,a=arguments.length,o=new Array(a),n=0;n<a;n++)o[n]=arguments[n];return(r=t.call.apply(t,[this].concat(o))||this).loading=!0,r.tipText=e().translator.trans("xypp-pay-to-read.forum.payment.loading"),r.btnText=e().translator.trans("xypp-pay-to-read.forum.payment.loading"),r.item_id=-1,r}a=t,(r=o).prototype=Object.create(a.prototype),r.prototype.constructor=r,b(r,a);var n=o.prototype;return n.className=function(){return"Modal--small PayModal"},n.title=function(){return e().translator.trans("xypp-pay-to-read.forum.payment.title")},n.content=function(){return m("div",{className:"Modal-body"},this.tipText,m("div",{className:"paymodal-btn"},m(T(),{class:"Button Button--primary",loading:this.loading,disabled:this.loading,onclick:this.pay,"data-id":this.item_id},this.btnText)))},n.onready=function(){var t=this;this.loading=!0,this.item_id=this.attrs.item_id,e().request({url:e().forum.attribute("apiUrl")+"/pay-to-read/payment/",params:{id:this.attrs.item_id},method:"GET"}).then((function(r){"200"==r.code?(t.loading=!1,t.tipText=e().translator.trans("xypp-pay-to-read.forum.payment.tip",[r.amount,r.user_money]),t.btnText=e().translator.trans("xypp-pay-to-read.forum.payment.btn"),m.redraw()):(e().modal.close(),e().alerts.show({type:"error"},e().translator.trans("xypp-pay-to-read.forum.error."+r.status,[])))})).catch((function(t){e().alerts.show({type:"error"},e().translator.trans("xypp-pay-to-read.forum.error.internal_err")),e().modal.close()}))},n.pay=function(t){var r=this;this.loading=!0,e().request({url:e().forum.attribute("apiUrl")+"/pay-to-read/payment/pay",body:{id:$(t.currentTarget).attr("data-id")},method:"POST"}).then((function(t){r.loading=!1,""==t.data.attributes.error?(e().modal.close(),C()(e().history.getCurrent().url)):(e().modal.close(),e().alerts.show({type:"error"},e().translator.trans("xypp-pay-to-read.forum.error."+t.data.attributes.error,[])))})).catch((function(t){console.log(t),e().alerts.show({type:"error"},e().translator.trans("xypp-pay-to-read.forum.error.internal_err")),e().modal.close()}))},o}(v());function O(t){return"string"==typeof t?t:Array.isArray(t)?t.join(""):t.toString()}function P(t){console.log(t),e().current.matches(h())&&($(".ptr-block.ptr-payment-require.ptr-render").each((function(t,r){$(r).prepend($("<div></div>").addClass("ptr-tip-line").prepend($("<button></button>").text(e().translator.trans("xypp-pay-to-read.forum.payment-req.btn")).addClass("ptr-pay-btn Button Button--primary")).prepend($("<span></span>").addClass("ptr-pay-tip").text(e().translator.trans("xypp-pay-to-read.forum.payment-req.text",[$(r).attr("data-amount")]).join(""))))})),$(".ptr-block.ptr-notfound.ptr-render").each((function(t,r){$(r).prepend($("<div></div>").addClass("ptr-tip-line").prepend($("<span></span>").addClass("ptr-pay-tip").text(O(e().translator.trans("xypp-pay-to-read.forum.payment-notfound",[$(r).attr("data-id")])))))})),$(".ptr-block.ptr-render").each((function(t,r){$(r).removeClass("ptr-render"),$(r).prepend($("<div></div>").addClass("ptr-payment-tip").text(e().translator.trans("xypp-pay-to-read.forum.paymentTip",[$(r).attr("data-amount")])).append($("<div></div>").addClass("ptr-haspaid-tip").text($(r).attr("data-haspaid-cnt")?O(e().translator.trans("xypp-pay-to-read.forum.haspaidTip",[$(r).attr("data-haspaid-cnt")])):e().translator.trans("xypp-pay-to-read.forum.nopaidTip",[]))))})),e().session.user?$(".ptr-block .ptr-pay-btn").off("click").on("click",(function(t){var r=$(t.currentTarget.parentElement.parentElement);e().modal.show(k,{item_id:r.attr("data-id")})})):$(".ptr-block .ptr-pay-btn").off("click").on("click",(function(){return e().modal.show(y())})))}e().initializers.add("xypp/pay-to-read",(function(){(0,s.extend)(p().prototype,"oncreate",P),(0,s.extend)(d().prototype,"toolbarItems",(function(t){var r=this;t.add("pay-to-read",m(l(),{onclick:function(){r.attrs.composer.editor.insertAtCursor("[pay amount=1]"+e().translator.trans("xypp-pay-to-read.forum.editor.help")+"[/pay]");var t=r.attrs.composer.editor.getSelectionRange();r.attrs.composer.editor.moveCursorTo(t[1]-6)},icon:"fa fa-comment-dollar"},e().translator.trans("xypp-pay-to-read.forum.editor.label")))}))}))})(),module.exports=r})();
//# sourceMappingURL=forum.js.map